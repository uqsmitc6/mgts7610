<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MGTS7610: Language Helper Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #51247A 0%, #6B3AA0 100%);
            min-height: 100vh;
            color: #2d3748;
        }

        .dashboard-container {
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Header Section */
        .header {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2rem;
            background: linear-gradient(135deg, #51247A, #6B3AA0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-subtitle {
            color: #718096;
            font-size: 0.95rem;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #48bb78;
            color: white;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Controls Bar */
        .controls-bar {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 10px 40px 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #51247A;
            box-shadow: 0 0 0 3px rgba(81, 36, 122, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
        }

        .filter-select {
            padding: 9px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-select:focus {
            outline: none;
            border-color: #51247A;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #51247A, #6B3AA0);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(81, 36, 122, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        /* Activity Filter Bubbles */
        .activity-filters {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }

        .activity-bubble {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px 24px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            min-width: 150px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .activity-bubble:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .activity-bubble.active {
            background: linear-gradient(135deg, #51247A, #6B3AA0);
            color: white;
            border-color: #51247A;
        }

        .activity-bubble.all {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        }

        .activity-bubble.all.active {
            background: linear-gradient(135deg, #51247A, #6B3AA0);
        }

        .activity-count {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .activity-label {
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Insights Section */
        .insights-section {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        }

        .insights-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #2d3748;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .insight-card {
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #51247A;
        }

        .insight-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #51247A;
            margin-bottom: 4px;
        }

        .insight-label {
            font-size: 0.85rem;
            color: #718096;
        }

        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        }

        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
        }

        .chart-wrapper {
            position: relative;
            height: 200px;
        }

        /* Main Content Area */
        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 24px;
            min-height: 500px;
        }

        .main-content.conversation-view {
            grid-template-columns: 300px 1fr;
        }

        /* Conversations List */
        .conversations-panel {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            max-height: 600px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .conversations-header {
            padding-bottom: 12px;
            border-bottom: 2px solid #f1f5f9;
            margin-bottom: 12px;
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
        }

        .conversations-list::-webkit-scrollbar {
            width: 6px;
        }

        .conversations-list::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .conversations-list::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }

        .conversation-item {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .conversation-item:hover {
            border-color: #51247A;
            box-shadow: 0 2px 8px rgba(81, 36, 122, 0.1);
        }

        .conversation-item.active {
            border-color: #51247A;
            background: linear-gradient(135deg, rgba(81, 36, 122, 0.05), rgba(107, 58, 160, 0.05));
        }

        .conv-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .conv-activity-badge {
            background: linear-gradient(135deg, #51247A, #6B3AA0);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .conv-preview {
            color: #4a5568;
            font-size: 0.85rem;
            line-height: 1.3;
            margin-bottom: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .conv-meta {
            display: flex;
            gap: 10px;
            font-size: 0.75rem;
            color: #718096;
        }

        /* Conversation Details Panel */
        .conversation-details {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            overflow-y: auto;
            max-height: 600px;
        }

        .details-header {
            padding-bottom: 16px;
            border-bottom: 2px solid #f1f5f9;
            margin-bottom: 20px;
        }

        .details-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 12px;
        }

        .details-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            background: #f8fafc;
            border-radius: 8px;
            padding: 12px;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
        }

        .meta-label {
            font-size: 0.75rem;
            color: #718096;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .meta-value {
            color: #2d3748;
            font-size: 0.9rem;
        }

        /* Message Timeline */
        .messages-timeline {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message-bubble {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .message-bubble.assistant .message-avatar {
            background: linear-gradient(135deg, #51247A, #6B3AA0);
        }

        .message-bubble.user .message-avatar {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .message-content {
            flex: 1;
            background: #f8fafc;
            border-radius: 12px;
            padding: 12px 16px;
        }

        .message-bubble.user .message-content {
            background: rgba(72, 187, 120, 0.1);
        }

        .message-role {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .message-bubble.assistant .message-role {
            color: #51247A;
        }

        .message-bubble.user .message-role {
            color: #48bb78;
        }

        .message-text {
            color: #2d3748;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .message-text strong {
            font-weight: 600;
            color: #1a202c;
        }

        .message-time {
            font-size: 0.7rem;
            color: #a0aec0;
            margin-top: 4px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state h3 {
            font-size: 1.2rem;
            margin-bottom: 8px;
            color: #4a5568;
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-spinner {
            background: white;
            border-radius: 12px;
            padding: 32px;
            text-align: center;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #f3f4f6;
            border-top-color: #51247A;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
            z-index: 3000;
            animation: slideUp 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .toast.success {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .toast.error {
            background: linear-gradient(135deg, #f56565, #e53e3e);
        }

        .toast.info {
            background: linear-gradient(135deg, #51247A, #6B3AA0);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .main-content.conversation-view {
                grid-template-columns: 1fr;
            }
            
            .conversations-panel {
                max-height: 300px;
            }
        }

        @media (max-width: 768px) {
            .activity-filters {
                justify-content: center;
            }
            
            .insights-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .charts-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <div>Loading conversation data...</div>
        </div>
    </div>

    <!-- Main Dashboard Container -->
    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <div>
                    <h1>MGTS7610: Language Helper Dashboard</h1>
                    <div class="header-subtitle">Conversation analytics of student interactions with the language helper modules</div>
                </div>
                <div class="live-indicator">
                    <div class="live-dot"></div>
                    <span>LIVE</span>
                </div>
            </div>
            
            <!-- Controls Bar -->
            <div class="controls-bar">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search conversations...">
                    <span class="search-icon">üîç</span>
                </div>
                
                <select class="filter-select" id="dateFilter">
                    <option value="">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                </select>
                
                <button class="btn btn-primary" onclick="refreshData()">
                    üîÑ Refresh
                </button>
                
                <button class="btn btn-success" id="autoRefreshBtn" onclick="toggleAutoRefresh()">
                    ‚ö° Auto-refresh: OFF
                </button>
            </div>
        </div>

        <!-- Activity Filter Bubbles -->
        <div class="activity-filters" id="activityFilters">
            <!-- Dynamically populated -->
        </div>

        <!-- Insights Section -->
        <div class="insights-section">
            <div class="insights-header">
                <h2 class="section-title">Key Insights</h2>
                <button class="btn btn-primary" onclick="toggleCharts()" id="chartsToggle">
                    üìä Show Charts
                </button>
            </div>
            
            <div class="insights-grid" id="insightsGrid">
                <div class="insight-card">
                    <div class="insight-value" id="totalConversations">0</div>
                    <div class="insight-label">Total Conversations</div>
                </div>
                <div class="insight-card">
                    <div class="insight-value" id="avgDuration">0 min</div>
                    <div class="insight-label">Average Duration</div>
                </div>
                <div class="insight-card">
                    <div class="insight-value" id="mostActiveTime">--</div>
                    <div class="insight-label">Peak Activity Time</div>
                </div>
                <div class="insight-card">
                    <div class="insight-value" id="completionRate">0%</div>
                    <div class="insight-label">Completion Rate</div>
                </div>
                <div class="insight-card">
                    <div class="insight-value" id="avgExchanges">0</div>
                    <div class="insight-label">Avg Exchanges</div>
                </div>
                <div class="insight-card">
                    <div class="insight-value" id="longestConv">0 msgs</div>
                    <div class="insight-label">Longest Conversation</div>
                </div>
            </div>
        </div>

        <!-- Charts Section (Hidden by default) -->
        <div class="charts-section" id="chartsSection" style="display: none;">
            <div class="chart-container">
                <h3 class="chart-title">Activity Distribution</h3>
                <div class="chart-wrapper">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">Daily Message Volume</h3>
                <div class="chart-wrapper">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">Engagement Patterns</h3>
                <div class="chart-wrapper">
                    <canvas id="engagementChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content" id="mainContent">
            <!-- Conversations List Panel -->
            <div class="conversations-panel">
                <div class="conversations-header">
                    <h2 class="section-title">Conversations</h2>
                    <span style="color: #718096; font-size: 0.9rem;" id="conversationCount">0 total</span>
                </div>
                <div class="conversations-list" id="conversationsList">
                    <!-- Dynamically populated -->
                </div>
            </div>

            <!-- Conversation Details Panel -->
            <div class="conversation-details" id="conversationDetails">
                <div class="empty-state">
                    <h3>Select a conversation</h3>
                    <p>Click on any conversation to view its details</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let allConversations = [];
        let filteredConversations = [];
        let charts = {};
        let autoRefreshInterval = null;
        let currentConversationId = null;
        let selectedActivity = null;
        let chartsVisible = false;

        // Google Sheets URL (Messages tab)
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRm9VwLT6tXwy_THspFMEZt-E8SaPSPthSGO9yfnqEbuAsC5hwRtskM5YLpc2dRTg8S5fFppUv2H2O0/pub?output=csv';

        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            loadData();
        });

        function initializeEventListeners() {
            document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 300));
            document.getElementById('dateFilter').addEventListener('change', applyFilters);
        }

        // Data Loading Functions
        async function loadData() {
            showLoading(true);
            
            try {
                const response = await fetch(SHEET_URL);
                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }
                
                const csvText = await response.text();
                const parsed = Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true
                });

                if (parsed.errors.length > 0) {
                    console.warn('CSV parsing warnings:', parsed.errors);
                }

                processData(parsed.data);
                showToast('Data loaded successfully!', 'success');
                
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Failed to load data. Please try again.', 'error');
            } finally {
                showLoading(false);
            }
        }

        function processData(rawData) {
            // Group messages by Conversation ID
            const conversationsMap = {};
            
            rawData.forEach(row => {
                const convId = row['Conversation ID'];
                if (!convId) return;
                
                if (!conversationsMap[convId]) {
                    conversationsMap[convId] = {
                        id: convId,
                        messages: [],
                        activity: row['Activity'] || 'Unknown',
                        startTime: row['Timestamp'],
                        endTime: row['Timestamp']
                    };
                }
                
                conversationsMap[convId].messages.push({
                    number: row['Message Number'] || 0,
                    role: row['Role'] || 'unknown',
                    content: row['Content'] || '',
                    timestamp: row['Timestamp'] || '',
                    activity: row['Activity'] || 'Unknown'
                });
                
                // Update end time
                if (row['Timestamp'] > conversationsMap[convId].endTime) {
                    conversationsMap[convId].endTime = row['Timestamp'];
                }
            });

            // Convert to array and calculate metrics
            allConversations = Object.values(conversationsMap).map(conv => {
                // Sort messages by number
                conv.messages.sort((a, b) => a.number - b.number);
                
                // Calculate metrics
                const userMessages = conv.messages.filter(m => m.role === 'user').length;
                const assistantMessages = conv.messages.filter(m => m.role === 'assistant').length;
                
                return {
                    ...conv,
                    totalMessages: conv.messages.length,
                    userMessages,
                    assistantMessages,
                    exchanges: Math.min(userMessages, assistantMessages),
                    completed: userMessages >= 2 && assistantMessages >= 2,
                    date: conv.startTime ? new Date(conv.startTime).toISOString().split('T')[0] : '',
                    duration: calculateDuration(conv.startTime, conv.endTime),
                    firstMessage: conv.messages[0]?.content || ''
                };
            });

            // Sort by start time (most recent first)
            allConversations.sort((a, b) => new Date(b.startTime) - new Date(a.startTime));

            // Create activity filters
            createActivityFilters();
            applyFilters();
        }

        function calculateDuration(start, end) {
            if (!start || !end) return 0;
            const diff = new Date(end) - new Date(start);
            return Math.round(diff / 1000 / 60); // Duration in minutes
        }

        // Activity Filter Functions
        function createActivityFilters() {
            const activityCounts = {};
            allConversations.forEach(conv => {
                activityCounts[conv.activity] = (activityCounts[conv.activity] || 0) + 1;
            });

            const container = document.getElementById('activityFilters');
            
            // Add "All" bubble
            container.innerHTML = `
                <div class="activity-bubble all active" onclick="filterByActivity(null)">
                    <div class="activity-count">${allConversations.length}</div>
                    <div class="activity-label">All Conversations</div>
                </div>
            `;

            // Add activity bubbles
            Object.entries(activityCounts).forEach(([activity, count]) => {
                container.innerHTML += `
                    <div class="activity-bubble" onclick="filterByActivity('${activity}')">
                        <div class="activity-count">${count}</div>
                        <div class="activity-label">${activity}</div>
                    </div>
                `;
            });
        }

        function filterByActivity(activity) {
            selectedActivity = activity;
            
            // Update active state
            document.querySelectorAll('.activity-bubble').forEach(bubble => {
                bubble.classList.remove('active');
            });
            
            if (activity === null) {
                document.querySelector('.activity-bubble.all').classList.add('active');
            } else {
                event.currentTarget.classList.add('active');
            }
            
            applyFilters();
        }

        // Filter Functions
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const dateFilter = document.getElementById('dateFilter').value;
            
            filteredConversations = allConversations.filter(conv => {
                // Activity filter
                if (selectedActivity && conv.activity !== selectedActivity) return false;
                
                // Search filter
                if (searchTerm) {
                    const searchMatch = 
                        conv.id.toLowerCase().includes(searchTerm) ||
                        conv.activity.toLowerCase().includes(searchTerm) ||
                        conv.messages.some(m => m.content.toLowerCase().includes(searchTerm));
                    if (!searchMatch) return false;
                }
                
                // Date filter
                if (dateFilter && conv.date) {
                    const convDate = new Date(conv.date);
                    const now = new Date();
                    
                    switch (dateFilter) {
                        case 'today':
                            if (convDate.toDateString() !== now.toDateString()) return false;
                            break;
                        case 'week':
                            const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                            if (convDate < weekAgo) return false;
                            break;
                        case 'month':
                            const monthAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
                            if (convDate < monthAgo) return false;
                            break;
                    }
                }
                
                return true;
            });

            updateDashboard();
        }

        // Dashboard Update Functions
        function updateDashboard() {
            updateInsights();
            updateConversationsList();
            if (chartsVisible) {
                updateCharts();
            }
        }

        function updateInsights() {
            const totalConvs = filteredConversations.length;
            const avgDuration = totalConvs > 0 ? 
                Math.round(filteredConversations.reduce((sum, c) => sum + c.duration, 0) / totalConvs) : 0;
            
            // Find peak activity time
            const hourCounts = {};
            filteredConversations.forEach(conv => {
                if (conv.startTime) {
                    const hour = new Date(conv.startTime).getHours();
                    hourCounts[hour] = (hourCounts[hour] || 0) + 1;
                }
            });
            const peakHour = Object.keys(hourCounts).reduce((a, b) => 
                hourCounts[a] > hourCounts[b] ? a : b, '');
            const peakTime = peakHour ? `${peakHour}:00` : '--';
            
            const completedConvs = filteredConversations.filter(c => c.completed).length;
            const completionRate = totalConvs > 0 ? Math.round((completedConvs / totalConvs) * 100) : 0;
            const avgExchanges = totalConvs > 0 ? 
                (filteredConversations.reduce((sum, c) => sum + c.exchanges, 0) / totalConvs).toFixed(1) : 0;
            const longestConv = filteredConversations.reduce((max, c) => 
                c.totalMessages > max ? c.totalMessages : max, 0);

            document.getElementById('totalConversations').textContent = totalConvs;
            document.getElementById('avgDuration').textContent = avgDuration + ' min';
            document.getElementById('mostActiveTime').textContent = peakTime;
            document.getElementById('completionRate').textContent = completionRate + '%';
            document.getElementById('avgExchanges').textContent = avgExchanges;
            document.getElementById('longestConv').textContent = longestConv + ' msgs';
        }

        function updateConversationsList() {
            const container = document.getElementById('conversationsList');
            const count = document.getElementById('conversationCount');
            
            count.textContent = `${filteredConversations.length} total`;

            if (filteredConversations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No conversations found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredConversations.map(conv => `
                <div class="conversation-item ${conv.id === currentConversationId ? 'active' : ''}" 
                     onclick="showConversation('${conv.id}')">
                    <div class="conv-header">
                        <span style="font-size: 0.75rem; color: #a0aec0;">${formatDate(conv.startTime)}</span>
                        <span class="conv-activity-badge">${conv.activity}</span>
                    </div>
                    <div class="conv-preview">${truncateText(conv.firstMessage, 80)}</div>
                    <div class="conv-meta">
                        <span>üí¨ ${conv.totalMessages}</span>
                        <span>üîÑ ${conv.exchanges}</span>
                        ${conv.completed ? '<span>‚úÖ</span>' : ''}
                    </div>
                </div>
            `).join('');
        }

        function showConversation(convId) {
            const conv = allConversations.find(c => c.id === convId);
            if (!conv) return;

            currentConversationId = convId;
            
            // Update active state in list
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Update main content to conversation view
            document.getElementById('mainContent').classList.add('conversation-view');

            // Populate conversation details
            const detailsPanel = document.getElementById('conversationDetails');
            detailsPanel.innerHTML = `
                <div class="details-header">
                    <div class="details-title">Conversation Details</div>
                    <div class="details-meta">
                        <div class="meta-item">
                            <span class="meta-label">Activity</span>
                            <span class="meta-value">${conv.activity}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Started</span>
                            <span class="meta-value">${formatDateTime(conv.startTime)}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Duration</span>
                            <span class="meta-value">${conv.duration} minutes</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Messages</span>
                            <span class="meta-value">${conv.totalMessages}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Exchanges</span>
                            <span class="meta-value">${conv.exchanges}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Status</span>
                            <span class="meta-value">${conv.completed ? '‚úÖ Completed' : '‚è≥ In Progress'}</span>
                        </div>
                    </div>
                </div>

                <h3 style="margin-bottom: 16px; color: #2d3748; font-size: 1rem;">Conversation Timeline</h3>
                <div class="messages-timeline">
                    ${conv.messages.map(msg => `
                        <div class="message-bubble ${msg.role}">
                            <div class="message-avatar">
                                ${msg.role === 'assistant' ? 'ü§ñ' : 'üë§'}
                            </div>
                            <div class="message-content">
                                <div class="message-role">${msg.role === 'assistant' ? 'Language Helper' : 'Student'}</div>
                                <div class="message-text">${parseMarkdownBold(msg.content)}</div>
                                <div class="message-time">${formatDateTime(msg.timestamp)}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Chart Functions
        function toggleCharts() {
            chartsVisible = !chartsVisible;
            const chartsSection = document.getElementById('chartsSection');
            const toggleBtn = document.getElementById('chartsToggle');
            
            if (chartsVisible) {
                chartsSection.style.display = 'grid';
                toggleBtn.textContent = 'üìä Hide Charts';
                updateCharts();
            } else {
                chartsSection.style.display = 'none';
                toggleBtn.textContent = 'üìä Show Charts';
            }
        }

        function updateCharts() {
            updateActivityChart();
            updateTimelineChart();
            updateEngagementChart();
        }

        function updateActivityChart() {
            const ctx = document.getElementById('activityChart').getContext('2d');
            
            if (charts.activity) charts.activity.destroy();

            const activityCounts = {};
            filteredConversations.forEach(conv => {
                activityCounts[conv.activity] = (activityCounts[conv.activity] || 0) + 1;
            });

            charts.activity = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(activityCounts),
                    datasets: [{
                        data: Object.values(activityCounts),
                        backgroundColor: [
                            '#51247A', '#6B3AA0', '#8B5FC7', '#9D7BDB',
                            '#B19CE8', '#D4C5F9', '#48bb78', '#f093fb'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }

        function updateTimelineChart() {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            if (charts.timeline) charts.timeline.destroy();

            const dailyCounts = {};
            filteredConversations.forEach(conv => {
                if (conv.date) {
                    dailyCounts[conv.date] = (dailyCounts[conv.date] || 0) + conv.totalMessages;
                }
            });

            const sortedDates = Object.keys(dailyCounts).sort();
            const last7Days = sortedDates.slice(-7);

            charts.timeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days.map(d => formatDate(d)),
                    datasets: [{
                        label: 'Messages',
                        data: last7Days.map(d => dailyCounts[d]),
                        borderColor: '#51247A',
                        backgroundColor: 'rgba(81, 36, 122, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function updateEngagementChart() {
            const ctx = document.getElementById('engagementChart').getContext('2d');
            
            if (charts.engagement) charts.engagement.destroy();

            const lengthBins = {
                '1-3': 0,
                '4-6': 0,
                '7-10': 0,
                '11+': 0
            };

            filteredConversations.forEach(conv => {
                const len = conv.totalMessages;
                if (len <= 3) lengthBins['1-3']++;
                else if (len <= 6) lengthBins['4-6']++;
                else if (len <= 10) lengthBins['7-10']++;
                else lengthBins['11+']++;
            });

            charts.engagement = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(lengthBins),
                    datasets: [{
                        label: 'Conversations',
                        data: Object.values(lengthBins),
                        backgroundColor: 'rgba(81, 36, 122, 0.8)',
                        borderColor: '#51247A',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Auto-refresh Functions
        function toggleAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                btn.textContent = '‚ö° Auto-refresh: OFF';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-primary');
                showToast('Auto-refresh disabled', 'info');
            } else {
                autoRefreshInterval = setInterval(refreshData, 30000); // Refresh every 30 seconds
                btn.textContent = '‚ö° Auto-refresh: ON';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-success');
                showToast('Auto-refresh enabled (30s)', 'success');
            }
        }

        function refreshData() {
            loadData();
        }

        // Utility Functions
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function parseMarkdownBold(text) {
            if (!text) return '';
            // Convert **text** to <strong>text</strong>
            return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideUp 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'Unknown';
            const date = new Date(dateStr);
            if (isNaN(date)) return dateStr;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return 'Unknown';
            const date = new Date(dateStr);
            if (isNaN(date)) return dateStr;
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zapier Conversations Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2d3748;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: #718096;
            font-size: 1.1rem;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .control-group {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            flex: 1;
            min-width: 250px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
        }

        input[type="file"],
        select,
        input[type="date"],
        input[type="text"] {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            color: #718096;
            margin-top: 5px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.3rem;
            color: #2d3748;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .conversations-table {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        tr:hover {
            background: #f7fafc;
        }

        .view-btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .close {
            color: #a0aec0;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #2d3748;
        }

        .message {
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
        }

        .message.user {
            background: #e6fffa;
            border-left: 4px solid #4fd1c5;
        }

        .message.assistant {
            background: #f0f4f8;
            border-left: 4px solid #667eea;
        }

        .message-role {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .message-content {
            color: #4a5568;
            line-height: 1.6;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #718096;
        }

        #searchBox {
            margin-bottom: 20px;
        }

        .highlight {
            background-color: yellow;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Zapier Conversations Dashboard</h1>
            <p class="subtitle">Complete analytics for student-bot interactions</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="fileInput">Upload JSON File:</label>
                <input type="file" id="fileInput" accept=".json">
                <button onclick="loadSampleData()" style="margin-top: 10px; width: 100%;">Load Sample Data</button>
            </div>
            
            <div class="control-group">
                <label for="activityFilter">Filter by Activity:</label>
                <select id="activityFilter" onchange="filterData()">
                    <option value="all">All Activities</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="dateFrom">Date From:</label>
                <input type="date" id="dateFrom" onchange="filterData()">
                <label for="dateTo" style="margin-top: 10px;">Date To:</label>
                <input type="date" id="dateTo" onchange="filterData()">
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value">-</div>
                <div class="stat-label">Total Conversations</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">-</div>
                <div class="stat-label">Unique Activities</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">-</div>
                <div class="stat-label">Avg Duration (min)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">-</div>
                <div class="stat-label">Avg Exchanges</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">-</div>
                <div class="stat-label">Completion Rate</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <h3 class="chart-title">Activity Distribution</h3>
                <canvas id="activityChart"></canvas>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">Hourly Activity Pattern</h3>
                <canvas id="hourlyChart"></canvas>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">Engagement Over Time</h3>
                <canvas id="timelineChart"></canvas>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">Duration Distribution</h3>
                <canvas id="durationChart"></canvas>
            </div>
        </div>

        <div class="conversations-table">
            <h3 class="chart-title">Individual Conversations</h3>
            <input type="text" id="searchBox" placeholder="Search conversations..." onkeyup="searchConversations()">
            <div class="export-buttons">
                <button onclick="exportToCSV()">Export to CSV</button>
                <button onclick="exportToJSON()">Export Filtered Data</button>
            </div>
            <div id="tableContainer">
                <p class="loading">Load data to view conversations</p>
            </div>
        </div>
    </div>

    <div id="conversationModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 style="margin-bottom: 20px;">Conversation Details</h2>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let charts = {};

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            
            // Try to load data from window.fs if available
            if (window.fs && window.fs.readFile) {
                loadFromWindowFS();
            }
        });

        async function loadFromWindowFS() {
            try {
                const fileContent = await window.fs.readFile('Chatbot Sessions.json', { encoding: 'utf8' });
                const parsedData = JSON.parse(fileContent);
                if (parsedData.data) {
                    processData(parsedData.data);
                }
            } catch (error) {
                console.log('No data in window.fs, waiting for file upload');
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const json = JSON.parse(e.target.result);
                        const data = json.data || json;
                        processData(data);
                    } catch (error) {
                        alert('Error parsing JSON file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }

        function loadSampleData() {
            // This would load the data from window.fs if available
            loadFromWindowFS();
        }

        function processData(rawData) {
            allData = rawData.map(conv => {
                const firstMessage = conv.messages && conv.messages[0] ? conv.messages[0].content : '';
                
                // Identify activity type
                let activity = 'Unknown';
                if (firstMessage.includes('Email Subject Lines')) activity = 'Email Subject Lines';
                else if (firstMessage.includes('Writing Effective Sentences')) activity = 'Writing Effective Sentences';
                else if (firstMessage.includes('Animating Sources')) activity = 'Animating Sources';
                else if (firstMessage.includes('Acknowledgement of Country')) activity = 'Acknowledgement of Country';
                else if (firstMessage.includes('Tone and Face')) activity = 'Tone and Face in Communication';
                else if (firstMessage.includes('Hedging and Boosting')) activity = 'Hedging and Boosting';
                else if (firstMessage.includes('Problem-Solution')) activity = 'Problem-Solution Proposals';
                
                // Calculate metrics
                const startTime = new Date(conv.createdAt);
                const endTime = new Date(conv.updatedAt);
                const durationMinutes = (endTime - startTime) / (1000 * 60);
                
                const userMessages = conv.messages.filter(m => m.role === 'user').length;
                const assistantMessages = conv.messages.filter(m => m.role === 'assistant').length;
                
                // Check if conversation was completed (heuristic: more than 2 exchanges)
                const completed = userMessages >= 2;
                
                return {
                    id: conv.id,
                    activity: activity,
                    createdAt: conv.createdAt,
                    updatedAt: conv.updatedAt,
                    startTime: startTime,
                    endTime: endTime,
                    date: startTime.toISOString().split('T')[0],
                    hour: startTime.getHours(),
                    durationMinutes: durationMinutes,
                    totalMessages: conv.messages.length,
                    userMessages: userMessages,
                    assistantMessages: assistantMessages,
                    exchanges: Math.min(userMessages, assistantMessages),
                    completed: completed,
                    messages: conv.messages
                };
            });

            // Sort by date
            allData.sort((a, b) => b.startTime - a.startTime);
            
            populateFilters();
            filterData();
        }

        function populateFilters() {
            const activities = [...new Set(allData.map(d => d.activity))].sort();
            const activityFilter = document.getElementById('activityFilter');
            activityFilter.innerHTML = '<option value="all">All Activities</option>';
            activities.forEach(activity => {
                activityFilter.innerHTML += `<option value="${activity}">${activity}</option>`;
            });

            // Set date range
            if (allData.length > 0) {
                const dates = allData.map(d => d.startTime);
                document.getElementById('dateFrom').value = new Date(Math.min(...dates)).toISOString().split('T')[0];
                document.getElementById('dateTo').value = new Date(Math.max(...dates)).toISOString().split('T')[0];
            }
        }

        function filterData() {
            const activity = document.getElementById('activityFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            filteredData = allData.filter(d => {
                if (activity !== 'all' && d.activity !== activity) return false;
                if (dateFrom && d.date < dateFrom) return false;
                if (dateTo && d.date > dateTo) return false;
                return true;
            });

            updateStats();
            updateCharts();
            updateTable();
        }

        function updateStats() {
            const stats = document.getElementById('statsGrid');
            const totalConversations = filteredData.length;
            const uniqueActivities = [...new Set(filteredData.map(d => d.activity))].length;
            const avgDuration = filteredData.reduce((sum, d) => sum + d.durationMinutes, 0) / filteredData.length || 0;
            const avgExchanges = filteredData.reduce((sum, d) => sum + d.exchanges, 0) / filteredData.length || 0;
            const completionRate = (filteredData.filter(d => d.completed).length / filteredData.length * 100) || 0;

            stats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalConversations}</div>
                    <div class="stat-label">Total Conversations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${uniqueActivities}</div>
                    <div class="stat-label">Unique Activities</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgDuration.toFixed(1)}</div>
                    <div class="stat-label">Avg Duration (min)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgExchanges.toFixed(1)}</div>
                    <div class="stat-label">Avg Exchanges</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${completionRate.toFixed(1)}%</div>
                    <div class="stat-label">Completion Rate</div>
                </div>
            `;
        }

        function updateCharts() {
            // Activity Distribution
            const activityCounts = {};
            filteredData.forEach(d => {
                activityCounts[d.activity] = (activityCounts[d.activity] || 0) + 1;
            });

            updateActivityChart(activityCounts);

            // Hourly Pattern
            const hourlyCounts = Array(24).fill(0);
            filteredData.forEach(d => {
                hourlyCounts[d.hour]++;
            });

            updateHourlyChart(hourlyCounts);

            // Timeline
            const dailyCounts = {};
            filteredData.forEach(d => {
                dailyCounts[d.date] = (dailyCounts[d.date] || 0) + 1;
            });

            updateTimelineChart(dailyCounts);

            // Duration Distribution
            const durationBins = [0, 5, 10, 15, 20, 30, 60, Infinity];
            const durationCounts = Array(durationBins.length - 1).fill(0);
            filteredData.forEach(d => {
                for (let i = 0; i < durationBins.length - 1; i++) {
                    if (d.durationMinutes >= durationBins[i] && d.durationMinutes < durationBins[i + 1]) {
                        durationCounts[i]++;
                        break;
                    }
                }
            });

            updateDurationChart(durationCounts, durationBins);
        }

        function updateActivityChart(data) {
            const ctx = document.getElementById('activityChart').getContext('2d');
            
            if (charts.activity) charts.activity.destroy();
            
            charts.activity = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#f5576c',
                            '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateHourlyChart(data) {
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            
            if (charts.hourly) charts.hourly.destroy();
            
            charts.hourly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'Conversations',
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateTimelineChart(data) {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            if (charts.timeline) charts.timeline.destroy();
            
            const sortedDates = Object.keys(data).sort();
            
            charts.timeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Daily Conversations',
                        data: sortedDates.map(date => data[date]),
                        backgroundColor: 'rgba(118, 75, 162, 0.2)',
                        borderColor: 'rgba(118, 75, 162, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateDurationChart(counts, bins) {
            const ctx = document.getElementById('durationChart').getContext('2d');
            
            if (charts.duration) charts.duration.destroy();
            
            const labels = bins.slice(0, -1).map((bin, i) => {
                const next = bins[i + 1];
                if (next === Infinity) return `${bin}+ min`;
                return `${bin}-${next} min`;
            });
            
            charts.duration = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Conversations',
                        data: counts,
                        backgroundColor: 'rgba(245, 87, 108, 0.6)',
                        borderColor: 'rgba(245, 87, 108, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateTable() {
            const container = document.getElementById('tableContainer');
            
            if (filteredData.length === 0) {
                container.innerHTML = '<p class="loading">No conversations found</p>';
                return;
            }
            
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Activity</th>
                            <th>Duration (min)</th>
                            <th>Exchanges</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredData.slice(0, 100).forEach(conv => {
                const date = conv.startTime.toLocaleDateString();
                const time = conv.startTime.toLocaleTimeString();
                const status = conv.completed ? '✅ Completed' : '⏸️ Incomplete';
                
                tableHTML += `
                    <tr>
                        <td>${date}</td>
                        <td>${time}</td>
                        <td>${conv.activity}</td>
                        <td>${conv.durationMinutes.toFixed(1)}</td>
                        <td>${conv.exchanges}</td>
                        <td>${status}</td>
                        <td><button class="view-btn" onclick="viewConversation('${conv.id}')">View</button></td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            
            if (filteredData.length > 100) {
                tableHTML += '<p style="margin-top: 10px; color: #718096;">Showing first 100 conversations. Export to CSV for complete data.</p>';
            }
            
            container.innerHTML = tableHTML;
        }

        function viewConversation(id) {
            const conv = allData.find(c => c.id === id);
            if (!conv) return;
            
            const modal = document.getElementById('conversationModal');
            const modalBody = document.getElementById('modalBody');
            
            let html = `
                <p><strong>Activity:</strong> ${conv.activity}</p>
                <p><strong>Date:</strong> ${conv.startTime.toLocaleString()}</p>
                <p><strong>Duration:</strong> ${conv.durationMinutes.toFixed(1)} minutes</p>
                <p><strong>Total Exchanges:</strong> ${conv.exchanges}</p>
                <hr style="margin: 20px 0;">
                <h3>Conversation Messages:</h3>
            `;
            
            conv.messages.forEach(msg => {
                const roleClass = msg.role === 'user' ? 'user' : 'assistant';
                const roleLabel = msg.role === 'user' ? 'Student' : 'Bot';
                html += `
                    <div class="message ${roleClass}">
                        <div class="message-role">${roleLabel}:</div>
                        <div class="message-content">${escapeHtml(msg.content)}</div>
                    </div>
                `;
            });
            
            modalBody.innerHTML = html;
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('conversationModal').style.display = 'none';
        }

        function searchConversations() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            if (!searchTerm) {
                updateTable();
                return;
            }
            
            const searchResults = filteredData.filter(conv => {
                return conv.messages.some(msg => 
                    msg.content.toLowerCase().includes(searchTerm)
                );
            });
            
            // Update table with search results
            const container = document.getElementById('tableContainer');
            
            if (searchResults.length === 0) {
                container.innerHTML = '<p class="loading">No conversations found matching your search</p>';
                return;
            }
            
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Activity</th>
                            <th>Duration (min)</th>
                            <th>Exchanges</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            searchResults.slice(0, 100).forEach(conv => {
                const date = conv.startTime.toLocaleDateString();
                const time = conv.startTime.toLocaleTimeString();
                const status = conv.completed ? '✅ Completed' : '⏸️ Incomplete';
                
                tableHTML += `
                    <tr>
                        <td>${date}</td>
                        <td>${time}</td>
                        <td>${conv.activity}</td>
                        <td>${conv.durationMinutes.toFixed(1)}</td>
                        <td>${conv.exchanges}</td>
                        <td>${status}</td>
                        <td><button class="view-btn" onclick="viewConversation('${conv.id}')">View</button></td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        function exportToCSV() {
            const csvData = filteredData.map(conv => {
                return {
                    'ID': conv.id,
                    'Activity': conv.activity,
                    'Date': conv.date,
                    'Start Time': conv.startTime.toISOString(),
                    'End Time': conv.endTime.toISOString(),
                    'Duration (minutes)': conv.durationMinutes.toFixed(2),
                    'Total Messages': conv.totalMessages,
                    'User Messages': conv.userMessages,
                    'Assistant Messages': conv.assistantMessages,
                    'Exchanges': conv.exchanges,
                    'Completed': conv.completed ? 'Yes' : 'No',
                    'First Message': conv.messages[0]?.content.substring(0, 200) || ''
                };
            });
            
            const csv = Papa.unparse(csvData);
            downloadFile(csv, 'conversations_export.csv', 'text/csv');
        }

        function exportToJSON() {
            const exportData = {
                exportDate: new Date().toISOString(),
                totalConversations: filteredData.length,
                filters: {
                    activity: document.getElementById('activityFilter').value,
                    dateFrom: document.getElementById('dateFrom').value,
                    dateTo: document.getElementById('dateTo').value
                },
                conversations: filteredData
            };
            
            const json = JSON.stringify(exportData, null, 2);
            downloadFile(json, 'conversations_filtered.json', 'application/json');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('conversationModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>